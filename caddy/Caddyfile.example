# Caddy reverse proxy for Nextcloud with Tailscale HTTPS
# 
# This enables iOS CalDAV sync with your self-hosted Nextcloud calendar.
#
# Setup:
#   1. Copy this file to Caddyfile
#   2. Replace YOUR_MACHINE.YOUR_TAILNET.ts.net with your Tailscale domain
#   3. Generate Tailscale certs: sudo tailscale cert YOUR_MACHINE.YOUR_TAILNET.ts.net
#   4. Copy certs to data/caddy/certs/
#   5. docker compose up -d caddy
#
# See IOS_CALDAV_SETUP.md for full instructions.

YOUR_MACHINE.YOUR_TAILNET.ts.net {
    tls /certs/YOUR_MACHINE.YOUR_TAILNET.ts.net.crt /certs/YOUR_MACHINE.YOUR_TAILNET.ts.net.key

    log {
        output stdout
        format console
    }

    # Handle CalDAV/CardDAV well-known redirects (critical for iOS)
    # iOS requires HTTPS redirects - Nextcloud's Apache returns HTTP by default
    redir /.well-known/caldav /remote.php/dav/ permanent
    redir /.well-known/carddav /remote.php/dav/ permanent

    reverse_proxy nextcloud:80 {
        header_up X-Forwarded-Proto https
        header_up X-Forwarded-Port 443
    }
}
