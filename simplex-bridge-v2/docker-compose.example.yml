version: '3.8'

services:
  simplex-bridge:
    build:
      context: ./simplex-bridge-v2
      dockerfile: Dockerfile
    container_name: simplex-bridge-v2
    restart: unless-stopped
    
    environment:
      # Required
      SIMPLEX_WS_URL: "ws://simplex-chat-cli:5225"
      N8N_WEBHOOK_URL: "http://n8n:5678/webhook/simplex-capture"
      
      # State & Logging
      SIMPLEX_STATE_FILE: "/app/scripts/state/simplex_last_seen.json"
      LOG_LEVEL: "INFO"  # DEBUG, INFO, WARNING, ERROR
      LOG_FILE: "/app/logs/bridge.log"
      
      # WebSocket
      SIMPLEX_POLL_SECONDS: "2"
      SIMPLEX_WS_TIMEOUT: "10"
      SIMPLEX_WS_RECONNECT_DELAY: "5"
      SIMPLEX_DEBUG_WS_EVENTS: "0"  # Set to "1" for verbose WS logging
      
      # Webhook
      SIMPLEX_WEBHOOK_RETRIES: "3"
      SIMPLEX_WEBHOOK_BACKOFF: "2"
      WEBHOOK_SECRET: ""  # Optional HMAC secret for webhook auth
      
      # HTTP Server
      BRIDGE_HTTP_PORT: "8080"
      BRIDGE_HTTP_BIND: "0.0.0.0"
      
      # Features
      SIMPLEX_HEALTH_CHECK: "1"  # Run health checks on startup
      ENABLE_METRICS: "1"        # Expose /metrics endpoint
      ENABLE_GROUP_CHAT: "0"     # Set to "1" to enable group message support
      
      # Rate Limiting
      RATE_LIMIT_PER_MINUTE: "20"  # Max messages per contact per minute
      
      # State Cleanup
      # SIMPLEX_STATE_CLEANUP_MAX_CONTACTS: "1000"  # Uncomment to override default
    
    volumes:
      # Persist state
      - ./data/simplex-bridge/state:/app/scripts/state
      # Persist logs
      - ./data/simplex-bridge/logs:/app/logs
    
    ports:
      # Expose HTTP endpoints (health, metrics, send)
      - "8080:8080"
    
    networks:
      - second-brain
    
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  second-brain:
    external: true
